**Whisker Breeze — 软硬件设计文档（v0.1 草案）**

- **MCU**: `CH32V003F4U6`（RISC‑V，WCH）
- **项目代号**: Whisker Breeze
- **固件栈**: `ch32fun` + C（见 `firmware/`）
- **当前固件入口**: `firmware/whisker_breeze.c`

—喵，心羽把连线都老老实实记下来了；你新补充的约束我已同步进表，并把仍需你确认的细节保留成填空项，方便继续推进。—

**概览**

- **供电**: `3V3` 轨；去耦就近布置 `C3 1µF` + `C4 100nF`（图左）。
- **时钟**: 使用内部 RC；`PA1` 被复用为 SSD1306 VBAT 开关控制，`PA2` 作模拟输入，未连接外部晶振。
- **调试/下载**: `PD1/SWIO` 单线调试；`PD7/NRST` 复位脚。
- **主要外设**: I2C（SSD1306 显示/外设中断 `INT`）、PWM（风扇）、若干模式输入与电源状态输入；UART 暂不使用。

**GPIO 与网络标号对照表（按原理图片面直读记录）**

- `PD7/NRST/T2CH4` ←→ `NRST`
- `PA1/OSCI/A1` ←→ `BAT`（SSD1306 VBAT 开关控制，驱动 PMOS 栅极）
- `PA2/OSCO/A0/T1CH2N` ←→ `TS`（温度或热敏采样，ADC 通道，前端待补充）
- `VSS` ←→ 数字地（GND）
- `PD0/T1CH1N/OPN1` ←→ `RES`（SSD1306 屏幕复位）
- `VDD` ←→ `3V3`
- `PC0/T2CH3/UTX_` ←→ `INT`（外设中断，板上无状态 LED）
- `PC1/SDA/NSS/T2CH4` ←→ `SDA`（I2C 数据）
- `PC2/SCL/URTS/T1BKIN` ←→ `SCL`（I2C 时钟）
- `PC3/T1CH3/T1CH1N_` ←→ `FAN_PWM`（风扇 PWM 输出，预计使用 `TIM1 CH3`）
- `PC4/A2/T1CH4/MCO` ←→ `FAN_EN`
- `PC5/SCK/T1ETR/T2CH1` ←→ `FAN_TOUCH`
- `PC6/MOSI/T1CH1N_` ←→ 空闲（可后续复用）
- `PC7/MISO/T1CH2_` ←→ `VBUS_PG`（来自 CH224Q，PG 脚典型为开漏输出，需上拉；有效电平待确认型号）
- `PD1/SWIO/AETR2` ←→ `PD1`（网络标号同名，推断为保留给 SWIO；请确认是否亦作 GPIO）
- `PD2/A3/T1CH1/T2CH3` ←→ `FAST`（模式输入）
- `PD3/A4/T2CH2/AETR` ←→ `MODE`（模式输入）
- `PD4/A7/UCK/T2CH1ETR` ←→ `SLOW`（模式输入）
- `PA5/UTX` ←→ `TX`（UART 发送，暂未使用）
- `PD5/URX` ←→ `RX`（UART 接收，暂未使用）

备注：板右下角的双线端子丝印为 `FAN_EN`、`FAN_TOUCH`，已确认分别对应 MCU `PC4`、`PC5`。

说明：以上完全按提供的图片丝印与网络标号直读记录；凡无法 100% 确认之处均未武断推断，并在“待补充”列出。

**硬件设计要点**

- **去耦布置**: `C3 1µF` + `C4 100nF` 贴近 `VDD` 与 `VSS`，优先走最短回流路径。
- **电源门控**: `BAT` 由 `PA1` 控制 SSD1306 的 VBAT PMOS 开关；需确认栅极驱动极性与限流。
- **ADC**: `TS` 接至 `PA2(A0)`；需前端参数与滤波配置；采样时序与满量程映射待定。
- **I2C**: `PC1/PC2` 用于 SSD1306（I2C），以及潜在外设；`INT` 由 `PC0` 承担；I2C 上拉阻值待确认。
- **PWM**: `PC3` → `TIM1_CH3` 建议 PWM 频率 20–30 kHz（避开可闻噪声）。
- **UART**: `PA5(TX)`、`PD5(RX)` 保留但暂不启用（固件默认关闭日志/printf）。
- **下载/调试**: 保留 `PD1/SWIO`、`PD7/NRST` 接线/测试点；避免被外设硬拉电平影响。

**软件架构**

- **启动**: `SystemInit()` → 外设与 GPIO 初始化 → 主循环。
- **模块划分**:
  - **board**: 管脚/时钟/中断优先级与 `funGpioInitAll()` 封装。
  - **drivers.uart**: 串口 printf/日志、命令行（可选）。
  - **drivers.i2c**: I2C 事务与 `INT` 中断回调（外设型号待定）。
  - **drivers.display**: SSD1306 I2C 驱动与绘图基元，复位脚 `RES` 与 VBAT 开关 `BAT` 控制。
  - **drivers.pwm**: `TIM1_CH3` 占空控制，闭环接口预留。
  - **drivers.adc**: 通道轮询采样（`TS` 等模拟量）。
  - **app.modes**: `SLOW/MODE/FAST` 去抖、边沿检测与状态机。
  - **app.fan**: 依据模式与传感量输出 PWM，占空软启动与限幅保护。
  - **app.power**: `VBUS_PG` 监测、欠压/掉电管理。
- **日志**: UART 暂不使用；保留可编译开关，后续需要时开启。

**时序与参数建议（待确认后落表）**

- **PWM 频率**: `20 kHz`（建议 20–30kHz）
- **ADC 采样周期**: `200 ms`（建议 100–500ms，视滤波而定）
- **UART 波特率**: `未使用`
- **模式输入有效电平**: `SLOW 低有效` / `MODE 低有效` / `FAST 低有效`
- **VBUS_PG 有效电平**: `低电平有效`（CH224Q 的 PG 多为开漏，需上拉；有效极性请确认所用子型号）

**固件与硬件一致性调整**

- 取消状态 LED：板上无 LED，移除固件中 `STATUS_LED`=PC0 的定义与心跳翻转逻辑；PC0 仅作 `INT`。
- UART 默认关闭：保持接口保留但不初始化/不打印。

**硬件/原理图待补充清单（填空题）**

1) `TS` 前端参数（按图）：若为 NTC，阻值 `10 kΩ@25°C`、β 值 `3950`、参考分压/激励 `3V3 通过 8.2 kΩ 上拉`；采样 RC `≈0.55 ms（8.2 kΩ ∥ 10 kΩ 配 100 nF）`。
2) `INT` 来源与有效极性：来源器件 `INA226`；有效电平 `低`；是否需上拉 `是`，阻值 `4.7 kΩ`。
3) I2C 上拉：`SDA/SCL` 上拉阻值 `4.7 kΩ`，电压域 `3V3`。
4) SSD1306 细节：I2C 地址 `0x3C`；`RES` 有效电平 `低/高`（通常为低有效），复位脉宽 `≥3 µs`。
5) `SLOW/MODE/FAST`：低有效，使用 TM-2024A 四脚两档/按压开关，`C` 脚接 `GND`，`1`/`2` 脚分别接 MCU 的模式输入并使能内部上拉（≈`47 kΩ` @3V3，`T` 脚可保留作按压检测或悬空）；硬件不加电容，固件以 ≥`5 ms` 的软件去抖窗口滤除机械抖动。
6) `VBUS_PG`（CH224Q）：PG 脚是否开漏 `是`；上拉到 `3V3`，阻值 `100 kΩ`；有效极性 `低`。
7) 系统时钟来源：`内部 RC`。

**测试与验证建议**

- 上电自检：打印版本与电源状态；ADC 读数是否在合理范围。
- 模式输入：三路开关去抖验证与状态机切换。
- PWM：阶梯占空扫描，确认风扇听感与启停转矩；若有 `FAN_TOUCH/TACH`，验证转速反馈。
- I2C：SSD1306 初始化/刷新验证；外设 `INT` 触发路径验证。
- 下载与复位：`SWIO/NRST` 独立可用，不受外设硬拉干扰。

**文件与代码位置**

- 入口：`firmware/whisker_breeze.c`
- LED：板上无；固件需移除此定义与相关逻辑。
